function [clusPos_Z_Stat, clusPval_Z_Stat, clusPval_clusSize, clusPos_clusSize] = CCC_permutation_test(FrsTmPsiTrial,Ch1EvsFrsTmPha, Ch2EvsFrsTmPha, numPerms, freq_bins, time_bins, SR)


BandWidth=2; % BandWidth in Hz;
Qfac     =2; % Attenuation in db(-Qfac)
tCircMean=0.05;

tWidth   = 1.5;
tOffset  = 0.4;
FltPassDir = 'onepass';

[nTrials, nFreq, nTms] = size(Ch1EvsFrsTmPha);

PermPSICCC = zeros(5, nFreq, nTms);
PermPhaCCC = zeros(5, nFreq, nTms);

startTime = datetime('now');
disp(['Start Time: ', datestr(startTime)]);

% Generate Permutations
parfor perm = 1:numPerms
   % % Step 1: Generate surrogate R-peaks
   %  time_shifts = rand(size(ibi_series)) - 0.5; % in sec
   %  surrogate_rpeaks(perm,:) = cumsum(ibi_series) + time_shifts;

    % Time Lock the surrogate R Peaks to the Channel Data
    %[EvData] = time_lock_to_surrogate(ChDta, surrogate_rpeaks, SR, tWidth, tOffset, numPerms);
    permCh1 = Ch1EvsFrsTmPha(randperm(nTrials), :, :); % Shuffled data for Channel 1
    permCh2 = Ch2EvsFrsTmPha(randperm(nTrials), :, :); % Shuffled data for Channel 2

    % Step 2: Calculate ITC with the surrogate R-peaks (one per channel)
    [PermPSICCC(perm, :, :), PermPhaCCC(perm,:,:)] = Get_PSI_ByTrials(permCh1, permCh2,SR,tCircMean);

    fprintf('perm = %d \n', perm)
end

endTime = datetime('now');
disp(['End Time: ', datestr(endTime)]);

% Calculate elapsed time
elapsedTime = endTime - startTime;
disp(['Elapsed Time: ', char(elapsedTime)]);
% Define significance threshold and alpha level
THRESH_SUPRACLUSTER = 0.25; % Threshold for suprathreshold clusters
ALPHA = 0.25; % Alpha level for final significance testing

%PermPSICCC   = permute(PermPSICCC, [1,3,2]);  % re-order dimensions to: (NUMPERMS x TIME, FREQ)
%original_ITC = permute(original_ITC, [2,1]); % re-order dimensions to: (TIME, FREQ)

% Step 1: Compute z-scores
diff_sum_perm_mean = squeeze(mean(PermPSICCC)); % Mean of the permutation distribution
diff_sum_perm_std = squeeze(std(PermPSICCC)); % Standard deviation of permutation distribution

diffPerm_mean(1,:,:) = diff_sum_perm_mean;
diffPerm_std(1,:,:)  = diff_sum_perm_std;

% Normalize original data and permuted data
% FrsTmPsiTrial_zscored = (FrsTmPsiTrial - mean(FrsTmPsiTrial(:))) / std(FrsTmPsiTrial(:));
PermPSICCC_zscored = (PermPSICCC - mean(PermPSICCC(:))) / std(PermPSICCC(:));
FrsTmPsiTrial_zscored = (FrsTmPsiTrial - mean(FrsTmPsiTrial, 2)) ./ std(FrsTmPsiTrial, 0, 2);
% PermPSICCC_zscored = (PermPSICCC - mean(PermPSICCC, 2)) ./ std(PermPSICCC, 0, 2);

% Then calculate z-scores
zscores = (FrsTmPsiTrial_zscored - diff_sum_perm_mean) ./ diff_sum_perm_std;
zscores_perm = (PermPSICCC - diffPerm_mean) ./ diffPerm_std;

figure; % Sanity check that the distributions are normalized and overlapping so that my null hypothesis actually reflects my data 
histogram(mean(FrsTmPsiTrial_baseline_norm));
hold on 
histogram(mean(PermPSICCC_zscored));

% Step 2: Compute p-values from z-scores 
%p_orig = 2 * (1 - normcdf(zscores, 0, 1)); % no abs bc unidirectional 
p_orig = normcdf(zscores, 0, 1); % bc my data was normalized in itself I don't need the two tailed thig

% Step 3: Calculate z-scores for permutations
%p_perm = 2 * (1 - normcdf(zscores_perm, 0, 1)); % no abs bc unidirectional
p_perm =  normcdf(zscores_perm, 0, 1);

% Step 4: Prepare inputs for getSignifClusters
% Create a logical significance matrix for the original data
p_sig = p_orig < THRESH_SUPRACLUSTER;

% Call getSignifClusters to find clusters
[clusPval_Z_Stat, clusPos_Z_Stat, clusPval_clusSize, clusPos_clusSize] = ...
    getSignifClusters(p_sig, zscores, p_perm, zscores_perm, THRESH_SUPRACLUSTER, ALPHA);

% The output clusPos_Z_Stat and clusPos_clusSize will indicate positions of significant clusters
% clusPval_Z_Stat and clusPval_clusSize contain p-values for each detected cluster
end



% FrsTmPsiTrial_zscored = (FrsTmPsiTrial - mean(FrsTmPsiTrial, 2)) ./ std(FrsTmPsiTrial, 0, 2);
% PermPSICCC_zscored = (PermPSICCC - mean(PermPSICCC, 2)) ./ std(PermPSICCC, 0, 2);
% 
% 
baseline_period = [1 61];
baseline_mean = mean(FrsTmPsiTrial(:, baseline_period(1):baseline_period(2)), 2);
baseline_values_perm = mean(PermPSICCC(:, baseline_period(1):baseline_period(2)), 2); % Assuming 2nd dimension is time
FrsTmPsiTrial_baseline_norm = (FrsTmPsiTrial - baseline_mean) ./ std(FrsTmPsiTrial(:, baseline_period(1):baseline_period(2)), 0, 2);
PermPSICCC_baseline_norm = (PermPSICCC - baseline_values_perm) ./ std(PermPSICCC(:, baseline_period(1):baseline_period(2)), 0, 2);
% figure;
% histogram(FrsTmPsiTrial_baseline_norm)

% 
% % Calculate standard deviations across trials
% std_original = std(FrsTmPsiTrial_zscored, 0, 2);  % Std of each trial in original data
% std_permuted = std(PermPSICCC_zscored, 0, 2);     % Std of each trial in permuted data
% 
% % Plot the histograms of the standard deviations
% figure;
% histogram(std_original, 'Normalization', 'probability', 'FaceColor', 'b');
% hold on;
% histogram(std_permuted, 'Normalization', 'probability', 'FaceColor', 'r');
% 
% 
% 

% KDE Plot for the mean values of the z-scored original and permuted data
figure;

% Estimate KDE for original data
[f_original, xi_original] = ksdensity(mean(FrsTmPsiTrial_baseline_norm));

% Estimate KDE for permuted data
[f_perm, xi_perm] = ksdensity(squeeze(mean(mean(PermPSICCC_zscored,1),2))');

% Plot the KDEs
plot(xi_original, f_original, 'b', 'LineWidth', 2); % Original data in blue
hold on;
plot(xi_perm, f_perm, 'r', 'LineWidth', 2); % Permuted data in red

% Add titles and legend for clarity
title('Kernel Density Estimate of Original vs. Permuted Data Means');
xlabel('Mean Values');
ylabel('Density');
legend('Original Data', 'Permuted Data');
hold off;





